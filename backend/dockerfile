# ==============================
# 1️⃣ Builder stage
# ==============================
FROM python:3.11-slim AS builder

# Set working directory
WORKDIR /app

# Install system packages needed for GCP SDKs and builds
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc g++ build-essential curl \
 && rm -rf /var/lib/apt/lists/*

# Copy requirements and install dependencies (globally)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt


# ==============================
# 2️⃣ Final runtime stage
# ==============================
FROM python:3.11-slim

WORKDIR /app

# Copy Python dependencies from builder
COPY --from=builder /usr/local/lib/python3.11 /usr/local/lib/python3.11
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy application source code
COPY . .

# --- Environment setup ---
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PROJECT_ID=gift-list-agent \
    REGION=us-central1 \
    PORT=8080

# --- Remove cache (safety cleanup) ---
RUN find /app -type d -name "__pycache__" -exec rm -rf {} + || true

# --- Create a non-root user (for security) ---
RUN useradd -m appuser
USER appuser

# --- Expose FastAPI port ---
EXPOSE 8080

# --- Add Healthcheck (used by GKE / Docker) ---
HEALTHCHECK CMD curl --fail http://localhost:8080/health || exit 1

# ✅ IMPORTANT — your main.py is inside "app" folder
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8080"]
